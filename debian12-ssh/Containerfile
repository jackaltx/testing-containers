#####################################################
#  create provisioner user for ansible.  

FROM debian:12
ENV DEBIAN_FRONTEND=noninteractive

# Update and install required packages
RUN apt-get update && \
    apt-get install -y \
    python3 \
    sudo \
    systemd \
    openssh-server \
    python3-pip \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Mask unnecessary systemd services
RUN systemctl mask systemd-machine-id-commit.service


# I struggle here....I can set the user to the "sudo" group and pass in a password.
# But this user has no password and thus needs to have "unfettered" access to root.
# bleh......

# Create provisioner user and set up sudo
RUN useradd -m -s /bin/bash jackaltx && \
    echo "jackaltx ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/jackaltx

# Create ansible temp directory with proper permissions
RUN mkdir -p /tmp/ansible-jackaltx && \
    chown jackaltx:jackaltx /tmp/ansible-jackaltx && \
    chmod 700 /tmp/ansible-jackaltx

# Set up SSH
RUN mkdir -p /home/jackaltx/.ssh && \
    chmod 700 /home/jackaltx/.ssh

# SSH key will be added during build
ARG SSH_KEY
RUN echo "$SSH_KEY" > /home/jackaltx/.ssh/authorized_keys && \
    chmod 600 /home/jackaltx/.ssh/authorized_keys && \
    chown -R jackaltx:jackaltx /home/jackaltx/.ssh

# Configure SSH
RUN mkdir -p /run/sshd && \
    systemctl enable ssh